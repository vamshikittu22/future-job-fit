---
phase: 02-cover-letter
plan: 01
type: execute
wave: 1
depends_on: ['01-foundation']
files_modified:
  - src/features/cover-letter/CoverLetterContext.tsx
  - src/features/cover-letter/hooks/useCoverLetter.ts
  - src/features/cover-letter/lib/coverLetterStorage.ts
  - src/shared/types/index.ts
autonomous: true

must_haves:
  truths:
    - User can create a new cover letter associated with a job
    - Cover letter state persists across page refreshes
    - Multiple cover letters can be stored (up to 50)
    - Context provides CRUD operations for cover letters
  artifacts:
    - path: "src/features/cover-letter/CoverLetterContext.tsx"
      provides: "React Context for cover letter state management"
      exports: ["CoverLetterContext", "CoverLetterProvider", "useCoverLetter"]
    - path: "src/features/cover-letter/hooks/useCoverLetter.ts"
      provides: "Hook for accessing cover letter context"
    - path: "src/features/cover-letter/lib/coverLetterStorage.ts"
      provides: "localStorage persistence utilities"
  key_links:
    - from: "CoverLetterContext"
      to: "localStorage"
      via: "coverLetterStorage utilities"
    - from: "useCoverLetter hook"
      to: "CoverLetterContext"
      via: "React useContext"
---

<objective>
Create CoverLetterContext for state management following the pattern established by ResumeContext and JobContext. The context will manage cover letter data, generation workflow state, and persistence to localStorage.

Purpose: Centralized state management enables the guided cover letter generation workflow and ensures data persistence across sessions.
Output: CoverLetterContext with full CRUD operations, auto-save, and localStorage persistence.
</objective>

<execution_context>
@C:/Users/kittu/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02-cover-letter/02-RESEARCH.md
@src/shared/contexts/ResumeContext.tsx
@src/shared/contexts/JobContext.tsx
@src/features/cover-letter/types.ts

## Reference Patterns

ResumeContext pattern:
- Uses useReducer for state management
- Implements undo/redo with history tracking
- Auto-saves to localStorage with 2-second debounce
- Provides CRUD operations for all resume sections

JobContext pattern:
- Uses useReducer with action types
- Maintains currentJob and savedJobs lists
- Auto-saves with debounced effect
- localStorage keys: JOB_STORAGE_KEY, SAVED_JOBS_KEY

## Existing Types

CoverLetter type already defined:
- id, jobId, resumeSnapshotId
- promptAnswers: CoverLetterPromptAnswers
- variants: CoverLetterVariant[]
- selectedVariantId, editedContent
- status: CoverLetterStatus
- atsScore, keywordsUsed
- metadata with timestamps
</context>

<tasks>

<task type="auto">
  <name>Create CoverLetterContext state and reducer</name>
  <files>src/features/cover-letter/CoverLetterContext.tsx</files>
  <action>
    Create CoverLetterContext following JobContext patterns:
    
    1. Define state interface with:
       - currentCoverLetter: CoverLetter | null
       - savedCoverLetters: SavedCoverLetter[] (with version)
       - isGenerating: boolean
       - generationError: string | null
    
    2. Define action types:
       - SET_CURRENT_COVER_LETTER
       - ADD_COVER_LETTER
       - UPDATE_COVER_LETTER
       - REMOVE_COVER_LETTER
       - SET_GENERATING
       - SET_GENERATION_ERROR
       - SELECT_VARIANT
       - UPDATE_EDITED_CONTENT
       - SET_ATS_SCORE
    
    3. Implement reducer function handling all actions
    
    4. Create context provider with:
       - useReducer hook
       - localStorage load on mount
       - Auto-save effect (2-second debounce like JobContext)
       - Action wrapper functions (setCurrentCoverLetter, addCoverLetter, etc.)
    
    5. Export useCoverLetter hook that throws if used outside provider
    
    Use lodash debounce for auto-save, matching existing pattern.
    Storage key: 'coverLetterDraft' and 'savedCoverLetters'
    Max saved cover letters: 50 (consistent with MAX_SAVED_JOBS)
  </action>
  <verify>Check file compiles: npx tsc --noEmit src/features/cover-letter/CoverLetterContext.tsx</verify>
  <done>Context created with all actions, reducer, provider, and hook exports</done>
</task>

<task type="auto">
  <name>Create storage utilities and helper functions</name>
  <files>src/features/cover-letter/lib/coverLetterStorage.ts</files>
  <action>
    Create storage utilities following src/shared/lib/initialJobData.ts pattern:
    
    1. Define constants:
       - COVER_LETTER_STORAGE_KEY = 'coverLetterDraft'
       - SAVED_COVER_LETTERS_KEY = 'savedCoverLetters'
       - MAX_SAVED_COVER_LETTERS = 50
    
    2. Create initialCoverLetterData factory function:
       - Generates new CoverLetter with:
         - Unique ID (use crypto.randomUUID or Date.now())
         - jobId parameter
         - resumeSnapshotId from current resume
         - Empty promptAnswers
         - Empty variants array
         - status: 'draft'
         - metadata with createdAt/updatedAt
    
    3. Create storage helper functions:
       - saveCoverLetterDraft(coverLetter): void
       - loadCoverLetterDraft(): CoverLetter | null
       - saveCoverLettersList(coverLetters): void
       - loadCoverLettersList(): SavedCoverLetter[]
       - clearCoverLetterDraft(): void
    
    4. Add compression helper for large content:
       - Check if content exceeds 100KB
       - Use simple compression or warn about localStorage limits
    
    5. Export all utilities and constants
  </action>
  <verify>Run TypeScript check on new file</verify>
  <done>Storage utilities created with save/load/clear functions</done>
</task>

<task type="auto">
  <name>Export cover letter types from shared index</name>
  <files>src/shared/types/index.ts</files>
  <action>
    The types are already exported via the glob pattern on line 12:
    `export * from '@/features/cover-letter/types';`
    
    Verify this line exists and works by checking that CoverLetter, CoverLetterVariant, and CoverLetterPromptAnswers are accessible via `@/shared/types` import.
  </action>
  <verify>Check that types compile and are accessible</verify>
  <done>Types properly exported from shared index</done>
</task>

</tasks>

<verification>
1. CoverLetterContext compiles without TypeScript errors
2. All action types are properly typed
3. localStorage persistence works (test by creating cover letter, refreshing page)
4. useCoverLetter hook throws appropriate error when used outside provider
5. Auto-save debounce is working (2-second delay)
</verification>

<success_criteria>
- CoverLetterContext.tsx exists with full reducer, provider, and hook
- Cover letter state persists across page refreshes
- Up to 50 cover letters can be saved
- Context follows existing ResumeContext/JobContext patterns
</success_criteria>

<output>
After completion, create `.planning/phases/02-cover-letter/02-01-SUMMARY.md`
</output>
