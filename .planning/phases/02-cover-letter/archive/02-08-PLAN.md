---
phase: 02-cover-letter
plan: 08
type: execute
wave: 2
depends_on: ['02-01', '02-05']
files_modified:
  - src/features/cover-letter/components/VersionHistory.tsx
  - src/features/cover-letter/pages/CoverLetterEdit.tsx
autonomous: true

must_haves:
  truths:
    - Cover letters auto-save to localStorage every 3 seconds
    - Up to 20 versions are saved per cover letter
    - User can view version history
    - User can restore previous versions
    - User can delete old versions
  artifacts:
    - path: "src/features/cover-letter/components/VersionHistory.tsx"
      provides: "Version history list and restore UI"
    - path: "src/features/cover-letter/pages/CoverLetterEdit.tsx"
      provides: "Edit page with version history integration"
  key_links:
    - from: "VersionHistory"
      to: "CoverLetterContext"
      via: "Version CRUD operations"
---

<objective>
Implement version history for cover letters with auto-save, version list, restore, and delete functionality.

Purpose: Enable users to track changes and recover previous versions of their cover letters.
Output: Version history component and integration with edit page.
</objective>

<execution_context>
@C:/Users/kittu/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@src/shared/contexts/ResumeContext.tsx

## ResumeContext Version Pattern

From codebase:
```typescript
interface SavedVersion {
  id: string;
  name: string;
  timestamp: string;
  data: ResumeData;
}

// Save version
const saveResume = async (name: string = 'Draft'): Promise<void> => {
  const newVersion: SavedVersion = {
    id: Date.now().toString(),
    name,
    timestamp: new Date().toISOString(),
    data: { ...resumeData }
  };
  
  const updatedVersions = [
    newVersion,
    ...savedVersions.filter(v => v.id !== newVersion.id)
  ].slice(0, 20); // Keep 20 most recent
  
  setSavedVersions(updatedVersions);
};
```

## Cover Letter Version Requirements

- Auto-save current draft every 3 seconds during editing
- Manual save to version history on user action
- Store up to 20 versions
- Show timestamp and ATS score per version
- Restore replaces current draft
</context>

<tasks>

<task type="auto">
  <name>Create Version History component</name>
  <files>src/features/cover-letter/components/VersionHistory.tsx</files>
  <action>
    Create version history list component:
    
    1. Component structure:
       - Props:
         * versions: CoverLetterVersion[]
         * currentVersionId?: string
         * onRestore: (version: CoverLetterVersion) => void
         * onDelete: (versionId: string) => void
         * onRename?: (versionId: string, name: string) => void
    
    2. Version list:
       - Display as scrollable list
       - Each version card shows:
         * Version name (editable)
         * Timestamp (relative: "2 hours ago")
         * ATS score badge
         * Word count
         * Preview snippet (first 100 chars)
       
       - Current version highlighted
       - Sort by date (newest first)
    
    3. Actions per version:
       - "Restore" button (with confirmation)
       - "Delete" button (with confirmation)
       - "Rename" inline edit
       - "Preview" modal
    
    4. Empty state:
       - "No saved versions yet"
       - Explanation of auto-save
    
    5. Batch actions (stretch):
       - Select multiple
       - Delete selected
       - Export selected
    
    6. Layout:
       - Collapsible sidebar or drawer
       - Responsive design
       - Search/filter versions
  </action>
  <verify>Component renders version list with all details</verify>
  <done>VersionHistory component with restore and delete</done>
</task>

<task type="auto">
  <name>Create Cover Letter Edit page with version integration</name>
  <files>src/features/cover-letter/pages/CoverLetterEdit.tsx</files>
  <action>
    Create main edit page integrating all components:
    
    1. Component structure:
       - Route: /cover-letter/edit/:id
       - Uses CoverLetterContext
       - Layout with sidebar and main editor
    
    2. Page layout:
       - Header:
         * Title: "Edit Cover Letter"
         * Company and role info
         * Back button
         * Save status indicator
       
       - Main content (2-column):
         * Left: RichTextEditor (from Plan 02-04)
         * Right: ATS Score Panel + Suggestions (from Plan 02-06)
       
       - Sidebar/drawer:
         * VersionHistory component
         * Collapsible
    
    3. Auto-save integration:
       - Debounced save every 3 seconds
       - Visual indicator: "Saving..." / "Saved"
       - Save to draft in localStorage
    
    4. Version management:
       - "Save Version" button (manual save)
       - Load version history on mount
       - Handle restore (replace editor content)
       - Handle delete (remove from history)
    
    5. Action bar:
       - "Save Version" button
       - "Export" button (opens ExportModal)
       - "Preview" button (full-screen preview)
       - "Done" button (return to list)
    
    6. State management:
       - Load cover letter by ID from context
       - Track edited content separately
       - Sync with context on changes
    
    7. Error handling:
       - Cover letter not found state
       - Load error handling
       - Save error handling
    
    8. Add route in App.tsx:
       - /cover-letter/edit/:id
  </action>
  <verify>Edit page loads cover letter and integrates all components</verify>
  <done>CoverLetterEdit page with editor, ATS panel, and version history</done>
</task>

<task type="auto">
  <name>Update CoverLetterContext with version support</name>
  <files>src/features/cover-letter/CoverLetterContext.tsx</files>
  <action>
    Add version history support to context (already created in 02-01):
    
    1. Update state interface:
       - Add versionHistory: CoverLetterVersion[]
       - Add currentVersion: CoverLetterVersion | null
    
    2. Add actions:
       - SAVE_VERSION: Save current as new version
       - RESTORE_VERSION: Load version into current
       - DELETE_VERSION: Remove from history
       - RENAME_VERSION: Update version name
    
    3. Update reducer:
       - Handle all version actions
       - Limit to 20 versions (slice)
       - Persist to localStorage
    
    4. Update context value:
       - Add saveVersion() method
       - Add restoreVersion() method
       - Add deleteVersion() method
       - Expose versionHistory array
    
    5. localStorage keys:
       - 'coverLetterVersions_{coverLetterId}'
    
    6. CoverLetterVersion interface:
       - id, coverLetterId, name, content, atsScore, timestamp
  </action>
  <verify>Context supports all version operations</verify>
  <done>Version support added to CoverLetterContext</done>
</task>

</tasks>

<verification>
1. Auto-save triggers every 3 seconds during editing
2. Versions are saved and displayed in history
3. Restore replaces current content correctly
4. Delete removes version from history
5. Up to 20 versions are retained
6. Edit page integrates all components
</verification>

<success_criteria>
- Cover letters auto-save during editing
- Version history shows all saved versions
- User can restore any previous version
- User can delete unwanted versions
- Up to 20 versions stored per cover letter
- Edit page provides complete editing workflow
</success_criteria>

<output>
After completion, create `.planning/phases/02-cover-letter/02-08-SUMMARY.md`
</output>
