---
phase: 02-cover-letter
plan: 02
type: execute
wave: 1
depends_on: ['01-foundation']
files_modified:
  - src/shared/api/coverLetterAI.ts
  - supabase/functions/cover-letter-ai/index.ts
autonomous: true
user_setup:
  - service: supabase
    why: "Edge Function for cover letter AI generation"
    env_vars:
      - name: GEMINI_API_KEY
        source: "Supabase Dashboard -> Project Settings -> Secrets"

dependencies:
  external:
    - @tiptap/extension-placeholder
    
must_haves:
  truths:
    - AI service can generate 3 cover letter variants from resume + job data
    - Service uses guided prompting with user answers
    - Service integrates with existing ResumeAIService patterns
    - Edge Function handles AI provider calls securely
  artifacts:
    - path: "src/shared/api/coverLetterAI.ts"
      provides: "Client-side AI service for cover letter generation"
      exports: ["coverLetterAI", "CoverLetterGenerationRequest"]
    - path: "supabase/functions/cover-letter-ai/index.ts"
      provides: "Edge Function for secure AI calls"
  key_links:
    - from: "coverLetterAI service"
      to: "Supabase Edge Function"
      via: "supabase.functions.invoke"
---

<objective>
Create cover letter AI service that generates 3 variant cover letters using guided prompting. Follow existing ResumeAIService patterns for consistency.

Purpose: Enable AI-powered cover letter generation with human-in-the-loop workflow to reduce AI detection risk.
Output: coverLetterAI service client and Supabase Edge Function.
</objective>

<execution_context>
@C:/Users/kittu/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/02-cover-letter/02-RESEARCH.md
@src/shared/api/resumeAI.ts
@src/features/cover-letter/types.ts

## Key Research Findings

Guided prompting is MANDATORY due to AI detection risk:
- Raw AI generation = 60-70% detection rate
- Guided generation with user input = 15-25% detection rate
- 95% of Fortune 500 use AI detection tools

Prompt structure per research:
```typescript
interface CoverLetterPrompt {
  resumeContext: string;
  jobDescription: string;
  companyInfo: { name, mission, values };
  tone: 'formal' | 'conversational' | 'enthusiastic';
  focus: 'experience' | 'skills' | 'culture_fit' | 'balanced';
  wordCount: 250-400;
  approvedOutline: string[];
  personalNotes: string;
  avoidPhrases: string[];
}
```

## ResumeAIService Pattern

- Constructor reads VITE_AI_PROVIDER and VITE_AI_DEMO_MODE
- Methods call private callEdgeFunction which:
  1. Checks for user-provided API key in sessionStorage
  2. Falls back to demo mode if enabled
  3. Calls Supabase Edge Function
- Demo mode returns mock responses
- Methods: enhanceSection, analyzeSection, evaluateResume
</context>

<tasks>

<task type="auto">
  <name>Create CoverLetterAI service client</name>
  <files>src/shared/api/coverLetterAI.ts</files>
  <action>
    Create CoverLetterAIService class following ResumeAIService patterns:
    
    1. Define interfaces:
       - CoverLetterGenerationRequest:
         * resumeData: ResumeData
         * jobData: JobData
         * promptAnswers: CoverLetterPromptAnswers
         * tone: 'formal' | 'conversational' | 'enthusiastic'
         * focus: 'experience' | 'skills' | 'culture_fit' | 'balanced'
         * wordCount: number (default 300)
       
       - CoverLetterGenerationResponse:
         * variants: CoverLetterVariant[]
         * keywordsUsed: string[]
         * generationTime: number
    
    2. Implement CoverLetterAIService class:
       - Constructor reads same env vars as ResumeAIService
       - isDemoMode getter
       - Private callEdgeFunction method (reuse logic from resumeAI.ts)
       - Private getDemoResponse method for mock data
    
    3. Main method: generateCoverLetters(request)
       - Validates request
       - Calls 'generateCoverLetters' edge function
       - Returns CoverLetterGenerationResponse
       - Handles errors gracefully
    
    4. Additional methods:
       - analyzeForATS(content, jobDescription): ATS score and suggestions
       - detectRiskPhrases(content): Array of high-risk phrases
    
    5. Export singleton instance: coverLetterAI
    
    Use the same error handling and fallback patterns as resumeAI.ts.
    Share helper functions where possible (extract common logic).
  </action>
  <verify>TypeScript compilation passes</verify>
  <done>CoverLetterAI service created with generation and analysis methods</done>
</task>

<task type="auto">
  <name>Create Supabase Edge Function for cover letter generation</name>
  <files>supabase/functions/cover-letter-ai/index.ts</files>
  <action>
    Create Edge Function following supabase/functions/resume-ai/index.ts pattern:
    
    1. Set up Deno handler:
       - CORS headers
       - Request validation
       - Route by task parameter
    
    2. Implement 'generateCoverLetters' handler:
       - Extract request data (resume, job, prompt answers, tone, focus)
       - Build system prompt following guided prompting rules:
         * Use approved outline from promptAnswers
         * Avoid generic phrases
         * Include specific examples from resume
         * Reference company mission/values
         * STRICT 250-400 word count
       
       - Generate 3 variants with different:
         * Opening hooks
         * Body paragraph emphasis
         * Closing styles
       
       - Return JSON with variants array
    
    3. Implement 'analyzeCoverLetter' handler:
       - Score based on:
         * Keyword integration quality (30%)
         * Business letter format compliance (25%)
         * Tone alignment (15%)
         * Length optimization (10%)
         * Uniqueness/generic phrase detection (20%)
       
       - Return detailed breakdown and suggestions
    
    4. Add prompt engineering:
       - Use Gemini 1.5 Flash model
       - Temperature 0.7 for variety
       - Structured JSON output
       - Error handling with graceful degradation
    
    Follow the exact structure of resume-ai/index.ts for consistency.
  </action>
  <verify>Edge function compiles and deploys locally with supabase functions serve</verify>
  <done>Edge function with generateCoverLetters and analyzeCoverLetter tasks</done>
</task>

</tasks>

<verification>
1. coverLetterAI.generateCoverLetters() returns 3 variants in demo mode
2. Edge function accepts requests and returns properly formatted JSON
3. Error handling works (network failures, invalid input)
4. ATS analysis provides scores 0-100 with suggestions
</verification>

<success_criteria>
- CoverLetterAI service can generate 3 distinct cover letter variants
- Edge Function securely handles AI provider calls
- Demo mode provides realistic mock responses
- Service integrates with existing auth and error handling patterns
</success_criteria>

<output>
After completion, create `.planning/phases/02-cover-letter/02-02-SUMMARY.md`
</output>
