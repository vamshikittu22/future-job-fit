---
phase: 00-hardening
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/lib/analytics/analytics.ts
  - src/shared/lib/analytics/events.ts
  - src/shared/lib/ai/costTracker.ts
autonomous: true

must_haves:
  truths:
    - Analytics events captured for key user actions
    - AI usage cost tracking implemented
    - Dev tools show real-time metrics
    - Privacy-compliant (no PII in events)
  artifacts:
    - path: "src/shared/lib/analytics/analytics.ts"
      provides: "Analytics tracking system"
      exports: ["trackEvent", "AnalyticsEvent"]
    - path: "src/shared/lib/ai/costTracker.ts"
      provides: "AI cost tracking"
      exports: ["trackAICall", "getAICostSummary"]
  key_links:
    - from: "ResumeAI service"
      to: "Cost tracker"
      via: "trackAICall()"
---

<objective>
Add analytics stub and AI usage cost monitoring for operational visibility.

Purpose: Phase 1-3 will involve heavy AI usage; we need cost tracking. Analytics needed for product insights.
Output: Analytics system ready for Mixpanel/Amplitude, AI cost tracking visible in dev tools.
</objective>

<execution_context>
@C:/Users/kittu/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@src/shared/api/resumeAI.ts

## Current State
- No analytics tracking
- No AI cost monitoring
- ResumeAI service makes calls without usage tracking

## Future Needs
- Track cover letter generation usage
- Monitor AI costs per user/session
- Understand feature adoption
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Analytics System</name>
  <files>
    src/shared/lib/analytics/analytics.ts
    src/shared/lib/analytics/events.ts
    src/shared/lib/analytics/index.ts
  </files>
  <action>
    Create analytics tracking system (stub for now, ready for real provider):

    1. Define event types:
       ```typescript
       // src/shared/lib/analytics/events.ts
       export enum AnalyticsEvent {
         // Resume events
         RESUME_CREATED = 'resume_created',
         RESUME_UPDATED = 'resume_updated',
         RESUME_EXPORTED = 'resume_exported',
         
         // AI events
         AI_ENHANCE_USED = 'ai_enhance_used',
         AI_COVER_LETTER_GENERATED = 'ai_cover_letter_generated',
         AI_ATS_SCORED = 'ai_ats_scored',
         
         // Feature events
         TEMPLATE_CHANGED = 'template_changed',
         SECTION_ADDED = 'section_added',
         
         // Navigation
         PAGE_VIEW = 'page_view',
         WIZARD_STEP_COMPLETED = 'wizard_step_completed',
       }

       export interface EventProperties {
         [key: string]: string | number | boolean | undefined;
       }
       ```

    2. Create analytics provider interface:
       ```typescript
       // src/shared/lib/analytics/analytics.ts
       export interface AnalyticsProvider {
         track(event: string, properties?: EventProperties): void;
         identify(userId: string, traits?: EventProperties): void;
         page(name: string, properties?: EventProperties): void;
       }

       // Stub provider for development
       class ConsoleProvider implements AnalyticsProvider {
         track(event: string, properties?: EventProperties): void {
           if (import.meta.env.DEV) {
             console.log('[Analytics]', event, properties);
           }
         }
         
         identify(userId: string, traits?: EventProperties): void {
           if (import.meta.env.DEV) {
             console.log('[Analytics] Identify:', userId, traits);
           }
         }
         
         page(name: string, properties?: EventProperties): void {
           if (import.meta.env.DEV) {
             console.log('[Analytics] Page:', name, properties);
           }
         }
       }

       // Production provider (configure with Mixpanel/Amplitude later)
       let provider: AnalyticsProvider = new ConsoleProvider();

       export function setAnalyticsProvider(newProvider: AnalyticsProvider): void {
         provider = newProvider;
       }

       export function trackEvent(
         event: AnalyticsEvent, 
         properties?: EventProperties
       ): void {
         provider.track(event, properties);
       }

       export function identifyUser(
         userId: string, 
         traits?: EventProperties
       ): void {
         provider.identify(userId, traits);
       }

       export function trackPageView(
         pageName: string, 
         properties?: EventProperties
       ): void {
         provider.page(pageName, properties);
       }
       ```

    3. Create React hook:
       ```typescript
       // src/shared/lib/analytics/useAnalytics.ts
       import { useCallback } from 'react';
       import { trackEvent, AnalyticsEvent, EventProperties } from './analytics';

       export function useAnalytics() {
         const track = useCallback(
           (event: AnalyticsEvent, properties?: EventProperties) => {
             trackEvent(event, properties);
           },
           []
         );

         return { track };
       }
       ```

    4. Export from index.ts
  </action>
  <verify>
    1. `npm run lint` passes
    2. Console logging works in dev mode
    3. No tracking in production (until provider configured)
  </verify>
  <done>
    Analytics system implemented with stub provider.
    Ready for Mixpanel/Amplitude integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add AI Cost Tracking</name>
  <files>
    src/shared/lib/ai/costTracker.ts
    src/shared/lib/ai/index.ts
  </files>
  <action>
    Create AI usage and cost tracking:

    1. Define cost model:
       ```typescript
       // src/shared/lib/ai/costTracker.ts
       export interface AICallRecord {
         timestamp: string;
         provider: 'gemini' | 'openai' | 'groq';
         model: string;
         operation: string;
         inputTokens: number;
         outputTokens: number;
         estimatedCost: number; // in USD
         duration: number; // in ms
         success: boolean;
         error?: string;
       }

       // Cost per 1K tokens (approximate)
       const COST_RATES: Record<string, { input: number; output: number }> = {
         'gemini-1.5-flash': { input: 0.00035, output: 0.00105 },
         'gemini-1.5-pro': { input: 0.0035, output: 0.0105 },
         'gpt-4': { input: 0.03, output: 0.06 },
         'gpt-3.5-turbo': { input: 0.0015, output: 0.002 },
         'llama-3.1-70b': { input: 0.00059, output: 0.00079 },
       };

       const callHistory: AICallRecord[] = [];
       const MAX_HISTORY = 1000;
       ```

    2. Create tracking functions:
       ```typescript
       export function trackAICall(
         provider: string,
         model: string,
         operation: string,
         inputTokens: number,
         outputTokens: number,
         duration: number,
         success: boolean,
         error?: string
       ): AICallRecord {
         const rates = COST_RATES[model] || { input: 0.01, output: 0.03 };
         const inputCost = (inputTokens / 1000) * rates.input;
         const outputCost = (outputTokens / 1000) * rates.output;
         
         const record: AICallRecord = {
           timestamp: new Date().toISOString(),
           provider: provider as any,
           model,
           operation,
           inputTokens,
           outputTokens,
           estimatedCost: inputCost + outputCost,
           duration,
           success,
           error
         };

         callHistory.push(record);
         
         // Limit history size
         if (callHistory.length > MAX_HISTORY) {
           callHistory.shift();
         }

         // Log in dev mode
         if (import.meta.env.DEV) {
           console.log(
             `[AI Cost] ${operation}: $${record.estimatedCost.toFixed(4)} ` +
             `(${inputTokens} → ${outputTokens} tokens)`
           );
         }

         return record;
       }
       ```

    3. Create summary functions:
       ```typescript
       export function getAICostSummary(options?: {
         since?: Date;
         provider?: string;
         operation?: string;
       }): {
         totalCalls: number;
         successfulCalls: number;
         failedCalls: number;
         totalCost: number;
         totalInputTokens: number;
         totalOutputTokens: number;
         averageDuration: number;
         callsByOperation: Record<string, number>;
       } {
         let filtered = callHistory;
         
         if (options?.since) {
           filtered = filtered.filter(c => new Date(c.timestamp) >= options.since!);
         }
         if (options?.provider) {
           filtered = filtered.filter(c => c.provider === options.provider);
         }
         if (options?.operation) {
           filtered = filtered.filter(c => c.operation === options.operation);
         }

         const totalCalls = filtered.length;
         const successfulCalls = filtered.filter(c => c.success).length;
         const totalCost = filtered.reduce((sum, c) => sum + c.estimatedCost, 0);
         const totalDuration = filtered.reduce((sum, c) => sum + c.duration, 0);
         
         const callsByOperation: Record<string, number> = {};
         filtered.forEach(c => {
           callsByOperation[c.operation] = (callsByOperation[c.operation] || 0) + 1;
         });

         return {
           totalCalls,
           successfulCalls,
           failedCalls: totalCalls - successfulCalls,
           totalCost,
           totalInputTokens: filtered.reduce((sum, c) => sum + c.inputTokens, 0),
           totalOutputTokens: filtered.reduce((sum, c) => sum + c.outputTokens, 0),
           averageDuration: totalCalls > 0 ? totalDuration / totalCalls : 0,
           callsByOperation
         };
       }

       export function getCurrentSessionCost(): number {
         const sessionStart = sessionStorage.getItem('ai_session_start');
         const since = sessionStart ? new Date(sessionStart) : new Date();
         return getAICostSummary({ since }).totalCost;
       }
       ```

    4. Initialize session tracking:
       ```typescript
       export function initAISession(): void {
         if (!sessionStorage.getItem('ai_session_start')) {
           sessionStorage.setItem('ai_session_start', new Date().toISOString());
         }
       }
       ```

    5. Export from index.ts
  </action>
  <verify>
    1. Cost calculations are accurate
    2. Dev mode shows cost logging
    3. Summary functions work correctly
  </verify>
  <done>
    AI cost tracking implemented with per-call and session summaries.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Tracking into ResumeAI Service</name>
  <files>src/shared/api/resumeAI.ts</files>
  <action>
    Wire up AI cost tracking to ResumeAI service:

    1. Import cost tracker:
       ```typescript
       import { trackAICall, initAISession } from '@/shared/lib/ai/costTracker';
       
       // Initialize on service load
       initAISession();
       ```

    2. Track enhanceSection calls:
       ```typescript
       async enhanceSection(request: EnhanceRequest): Promise<EnhanceResponse> {
         const startTime = performance.now();
         
         try {
           const response = await this.makeRequest('enhance', request);
           
           const duration = performance.now() - startTime;
           trackAICall(
             this.provider,
             this.model,
             'enhance_section',
             this.estimateTokens(request.original_text),
             this.estimateTokens(JSON.stringify(response)),
             duration,
             true
           );
           
           return response;
         } catch (error) {
           const duration = performance.now() - startTime;
           trackAICall(
             this.provider,
             this.model,
             'enhance_section',
             this.estimateTokens(request.original_text),
             0,
             duration,
             false,
             String(error)
           );
           throw error;
         }
       }
       ```

    3. Add token estimation helper:
       ```typescript
       private estimateTokens(text: string): number {
         // Rough estimate: 1 token ≈ 4 characters for English
         return Math.ceil(text.length / 4);
       }
       ```

    4. Wire up analytics events:
       ```typescript
       import { trackEvent, AnalyticsEvent } from '@/shared/lib/analytics';
       
       // In enhanceSection success:
       trackEvent(AnalyticsEvent.AI_ENHANCE_USED, {
         section_type: request.section_type,
         provider: this.provider,
         demo_mode: this.isDemoMode
       });
       ```

    5. Add dev mode cost display:
       ```typescript
       if (import.meta.env.DEV) {
         console.log(`Session AI cost: $${getCurrentSessionCost().toFixed(4)}`);
       }
       ```
  </action>
  <verify>
    1. AI calls are tracked in cost tracker
    2. Analytics events fire for AI usage
    3. Dev console shows cost summary
  </verify>
  <done>
    ResumeAI service integrated with cost tracking and analytics.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add God Mode Analytics Panel</name>
  <files>
    src/shared/components/dev/AnalyticsPanel.tsx
  </files>
  <action>
    Extend God Mode console with analytics and cost tracking:

    1. Create analytics panel component:
       ```typescript
       // src/shared/components/dev/AnalyticsPanel.tsx
       import { useState, useEffect } from 'react';
       import { getAICostSummary, getCurrentSessionCost } from '@/shared/lib/ai/costTracker';

       export function AnalyticsPanel() {
         const [summary, setSummary] = useState(getAICostSummary());
         
         useEffect(() => {
           const interval = setInterval(() => {
             setSummary(getAICostSummary());
           }, 5000);
           return () => clearInterval(interval);
         }, []);

         return (
           <div className="space-y-4">
             <h3 className="font-bold">AI Usage</h3>
             
             <div className="grid grid-cols-2 gap-2 text-sm">
               <div>Session Cost:</div>
               <div className="font-mono">${getCurrentSessionCost().toFixed(4)}</div>
               
               <div>Total Cost:</div>
               <div className="font-mono">${summary.totalCost.toFixed(4)}</div>
               
               <div>Total Calls:</div>
               <div>{summary.totalCalls}</div>
               
               <div>Success Rate:</div>
               <div>
                 {summary.totalCalls > 0 
                   ? ((summary.successfulCalls / summary.totalCalls) * 100).toFixed(1)
                   : 0}%
               </div>
               
               <div>Tokens:</div>
               <div>
                 {summary.totalInputTokens.toLocaleString()} → {summary.totalOutputTokens.toLocaleString()}
               </div>
             </div>

             <h4 className="font-semibold text-sm mt-4">By Operation</h4>
             {Object.entries(summary.callsByOperation).map(([op, count]) => (
               <div key={op} className="flex justify-between text-sm">
                 <span>{op}:</span>
                 <span>{count}</span>
               </div>
             ))}
           </div>
         );
       }
       ```

    2. Integrate into God Mode console (existing component that shows on triple-click)

    3. Add recent events log:
       ```typescript
       // Show last 10 analytics events
       const [recentEvents, setRecentEvents] = useState([]);
       ```
  </action>
  <verify>
    1. Analytics panel renders in God Mode
    2. Cost updates in real-time
    3. Recent events visible
  </verify>
  <done>
    God Mode extended with analytics and cost tracking panel.
  </done>
</task>

</tasks>

<verification>
1. Analytics events fire for key actions
2. AI cost tracking accurate
3. Dev console shows real-time metrics
4. God Mode analytics panel works
5. No PII in tracked events
</verification>

<success_criteria>
- Analytics system implemented with event tracking
- AI cost tracking with per-call and session summaries
- ResumeAI service integrated with tracking
- God Mode shows analytics panel
- Privacy-compliant (no PII)
- Ready for production analytics provider
</success_criteria>

<output>
After completion, create `.planning/phases/00-hardening/00-04-SUMMARY.md`
</output>
