---
phase: 01-foundation
plan: 05
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: 
  - src/shared/hooks/useResumeJobBridge.ts
  - src/shared/hooks/index.ts
  - src/shared/components/bridge/StaleDataWarning.tsx
autonomous: true

must_haves:
  truths:
    - "Bridge hook useResumeJobBridge() combines data from ResumeContext and JobContext"
    - "Components use useResume() and useJob() hooks directly (per user decision)"
    - "ResumeContext remains central - resume is primary, job is secondary"
    - "Stale data warning displays when resume changes mid-analysis (not auto-refresh)"
    - "Combined data structure ready for AI prompts (resume + job data)"
  artifacts:
    - path: "src/shared/hooks/useResumeJobBridge.ts"
      provides: "Bridge hook combining Resume and Job contexts"
      exports: ["useResumeJobBridge", "ResumeJobCombinedData"]
    - path: "src/shared/hooks/index.ts"
      provides: "Centralized hook exports"
      exports: ["useResumeJobBridge"]
    - path: "src/shared/components/bridge/StaleDataWarning.tsx"
      provides: "Warning component for stale data detection"
      exports: ["StaleDataWarning", "useStaleDataCheck"]
  key_links:
    - from: "useResumeJobBridge hook"
      to: "ResumeContext"
      via: "useResume()"
      pattern: "const.*=.*useResume\\(\\)"
    - from: "useResumeJobBridge hook"
      to: "JobContext"
      via: "useJob()"
      pattern: "const.*=.*useJob\\(\\)"
    - from: "StaleDataWarning"
      to: "resumeData"
      via: "resume snapshot comparison"
      pattern: "resumeSnapshot.*!==.*current"
---

<objective>
Create cross-feature data bridge enabling ResumeContext and JobContext to work together for AI-powered features.

Purpose: Enable downstream features (Cover Letter, Interview Prep) to combine resume and job data for AI prompts. Implement stale data detection to warn users when resume changes after analysis/generation.
Output: Bridge hook combining both contexts, stale data warning component, and utilities for AI-ready data combination.
</objective>

<execution_context>
@C:/Users/kittu/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/kittu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Contexts to bridge
@src/shared/contexts/ResumeContext.tsx
@src/shared/contexts/JobContext.tsx (created in Plan 01)

# User decisions
@.planning/phases/01-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Resume-Job Bridge Hook</name>
  <files>src/shared/hooks/useResumeJobBridge.ts</files>
  <action>
    Create the bridge hook that combines ResumeContext and JobContext data.

    Implementation details (per user decision - bridge hooks pattern):

    1. ResumeJobCombinedData type:
       ```typescript
       interface ResumeJobCombinedData {
         // Resume data (primary)
         resume: {
           data: ResumeData;
           summary: string; // Formatted summary for AI prompts
           hasData: boolean; // Whether resume has meaningful content
         };
         
         // Job data (secondary)
         job: {
           data: JobData | null;
           current: SavedJob | null;
           savedJobs: SavedJob[];
           hasActiveJob: boolean; // Whether there's a current job selected
         };
         
         // Combined for AI prompts
         forAI: {
           resumeText: string; // Plain text representation of resume
           jobDescription: string; // Raw job description
           extractedRequirements: string[]; // Structured requirements
           context: string; // Combined context string for AI
         };
         
         // Status
         status: {
           isReady: boolean; // Both resume and job have data
           missingResume: boolean;
           missingJob: boolean;
         };
       }
       ```

    2. useResumeJobBridge() hook:
       - Use useResume() to get resume data
       - Use useJob() to get job data
       - Compute combined values:
         * resumeText: Convert ResumeData to plain text format
           - Include personal info, summary, experience bullets, education, skills, projects
           - Format: "Name: X\n\nSummary: Y\n\nExperience: ..."
         * context: Combine resume and job info into AI prompt context
           - "Candidate: {name}\nTarget Role: {job.title} at {job.company}\nResume: {resumeText}\nJob Description: {job.description}"
       - Return ResumeJobCombinedData object
       - Throw error if used outside both providers (like existing hooks)

    3. Helper functions (exported):
       - formatResumeForAI(resumeData: ResumeData): string
         * Converts structured resume to plain text for AI processing
         * Prioritizes experience bullets and skills
         * Truncates if too long (>4000 chars)
       
       - extractKeywordsFromJob(job: JobData): string[]
         * Extracts keywords from extractedFields
         * Returns array of important keywords for matching
       
       - generateAIContext(resume: ResumeData, job: JobData | null): string
         * Creates combined context string
         * Used for cover letter and interview generation prompts

    4. Performance considerations:
       - Use useMemo for expensive computations (formatResumeForAI, generateAIContext)
       - Only recompute when resumeData or currentJob changes

    5. Error handling:
       - If ResumeContext not available: throw "useResumeJobBridge must be used within ResumeProvider"
       - If JobContext not available: throw "useResumeJobBridge must be used within JobProvider"

    Import from:
    - src/shared/contexts/ResumeContext.tsx (useResume)
    - src/shared/contexts/JobContext.tsx (useJob)
    - src/shared/types/resume.ts (ResumeData)
    - src/shared/types/job.ts (JobData, SavedJob)
  </action>
  <verify>
    1. Run `npm run lint src/shared/hooks/useResumeJobBridge.ts` - no TypeScript errors
    2. Verify exports: grep -E "export.*(useResumeJobBridge|formatResumeForAI|extractKeywordsFromJob|generateAIContext)" src/shared/hooks/useResumeJobBridge.ts
    3. Verify useMemo usage: grep -E "useMemo" src/shared/hooks/useResumeJobBridge.ts
  </verify>
  <done>
    Bridge hook exists with ResumeJobCombinedData type, useResumeJobBridge hook,
    helper functions, useMemo optimization, and proper error handling for missing providers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Stale Data Warning Component</name>
  <files>src/shared/components/bridge/StaleDataWarning.tsx</files>
  <action>
    Create component that detects when resume has changed since analysis/generation and warns user (per user decision - not auto-refresh, show warning).

    Implementation details:

    1. useStaleDataCheck hook:
       ```typescript
       interface StaleDataCheckOptions {
         snapshotId: string; // Unique identifier for this analysis/generation
         resumeSnapshot: ResumeData; // Resume data at time of generation
         jobSnapshot?: JobData; // Optional job data at time of generation
       }
       
       interface StaleDataCheckResult {
         isStale: boolean; // True if current resume differs from snapshot
         resumeChanged: boolean;
         jobChanged: boolean;
         changes: {
           sections: string[]; // Which sections changed
           summary: 'unchanged' | 'modified' | 'added' | 'removed';
           experience: 'unchanged' | 'modified' | 'added' | 'removed';
           skills: 'unchanged' | 'modified' | 'added' | 'removed';
         };
       }
       ```
       
       - Hook compares current resumeData with stored resumeSnapshot
       - Compares current currentJob with stored jobSnapshot (if provided)
       - Returns detailed change information
       - Use deep equality comparison (JSON.stringify for simple check, or deep-equal library if available)

    2. StaleDataWarning component:
       ```typescript
       interface StaleDataWarningProps {
         isStale: boolean;
         changes: StaleDataCheckResult['changes'];
         onRegenerate?: () => void; // Callback when user clicks "Regenerate"
         onDismiss?: () => void; // Callback when user dismisses warning
         actionLabel?: string; // Button text, default "Regenerate"
         description?: string; // Custom message
       }
       ```
       
       - Display Alert or Callout component with warning styling (amber/orange)
       - Message: "Your resume has changed since you generated this [cover letter/interview/etc]. Regenerate?"
       - Show specific changes: "Summary modified, Experience section added"
       - Action button: "Regenerate" (calls onRegenerate)
       - Dismiss button: "Keep Current" (calls onDismiss)
       - Use shadcn/ui Alert or custom component matching Swiss design

    3. Snapshot storage utilities:
       - saveSnapshot(snapshotId: string, data: { resume: ResumeData; job?: JobData }): void
         * Saves to localStorage under key `fjf_snapshot_{snapshotId}`
       - loadSnapshot(snapshotId: string): { resume: ResumeData; job?: JobData } | null
         * Loads from localStorage
       - clearSnapshot(snapshotId: string): void
         * Removes from localStorage
       - These are thin wrappers around localStorage with error handling

    4. Usage pattern for downstream features:
       ```tsx
       // When generating:
       const snapshotId = generateId();
       saveSnapshot(snapshotId, { resume: resumeData, job: currentJob });
       // ... generate content ...
       
       // When displaying:
       const { isStale, changes } = useStaleDataCheck({
         snapshotId,
         resumeSnapshot: savedResume,
         jobSnapshot: savedJob
       });
       
       {isStale && (
         <StaleDataWarning
           isStale={isStale}
           changes={changes}
           onRegenerate={() => {/* regenerate */}}
         />
       )}
       ```

    5. Styling:
       - Match existing Swiss design system
       - Use amber/orange color scheme for warnings
       - Consistent spacing and typography

    Export: StaleDataWarning component, useStaleDataCheck hook, and snapshot utilities.
  </action>
  <verify>
    1. Run `npm run lint src/shared/components/bridge/StaleDataWarning.tsx` - no TypeScript errors
    2. Verify exports: grep -E "export.*(StaleDataWarning|useStaleDataCheck|saveSnapshot|loadSnapshot)" src/shared/components/bridge/StaleDataWarning.tsx
    3. Verify localStorage usage: grep -E "localStorage" src/shared/components/bridge/StaleDataWarning.tsx | wc -l >= 2
  </verify>
  <done>
    StaleDataWarning component and useStaleDataCheck hook created with:
    - Stale data detection comparing snapshots to current data
    - Detailed change reporting (which sections changed)
    - Snapshot storage utilities (save/load/clear)
    - Warning UI with regenerate/dismiss actions
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Hooks Index and Create Bridge Components Index</name>
  <files>
    src/shared/hooks/index.ts
    src/shared/components/bridge/index.ts
  </files>
  <action>
    Update exports to make bridge utilities easily accessible.

    1. src/shared/hooks/index.ts:
       Add export for the new bridge hook:
       ```typescript
       // Bridge hooks
       export { useResumeJobBridge } from './useResumeJobBridge';
       ```
       
       If the file doesn't exist, create it with all hook exports. Check existing hooks directory for other hooks to export.

    2. src/shared/components/bridge/index.ts:
       Create barrel file for bridge components:
       ```typescript
       export { StaleDataWarning, useStaleDataCheck } from './StaleDataWarning';
       export type { StaleDataCheckOptions, StaleDataCheckResult, StaleDataWarningProps } from './StaleDataWarning';
       ```

    3. Ensure the bridge directory exists:
       - src/shared/components/bridge/

    These barrel files enable clean imports:
    - `import { useResumeJobBridge } from '@/shared/hooks';`
    - `import { StaleDataWarning } from '@/shared/components/bridge';`
  </action>
  <verify>
    1. Run `npm run lint src/shared/hooks/index.ts` - no TypeScript errors
    2. Run `npm run lint src/shared/components/bridge/index.ts` - no TypeScript errors
    3. Verify exports work correctly
  </verify>
  <done>Hooks and components properly exported via barrel files</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npm run build` completes without errors
2. Bridge hook can be used: `const combined = useResumeJobBridge()` returns combined data
3. StaleDataWarning can be rendered: `<StaleDataWarning isStale={true} changes={...} />`
4. Snapshot utilities work: `saveSnapshot('test', { resume: data })` stores to localStorage
5. useMemo optimization prevents unnecessary recomputations
</verification>

<success_criteria>
- useResumeJobBridge() hook combines ResumeContext and JobContext data
- Combined data includes AI-ready formatted text (resumeText, context)
- StaleDataWarning component detects resume changes and displays warning
- Snapshot utilities persist generation state to localStorage
- Helper functions format resume for AI prompts and extract job keywords
- Components can use useResume() and useJob() directly (not forced through bridge)
- ResumeContext remains primary, JobContext secondary
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
